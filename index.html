<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>외대부고 국어 기말대비 퀴즈 드라이빙</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
    <script>
        function setScreenHeight() {
            let vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        }
        setScreenHeight();
        window.addEventListener('resize', setScreenHeight);
    </script>
    <style>
        body {
            font-family: 'Jua', sans-serif;
            touch-action: manipulation;
        }
        #game-container {
            height: calc(var(--vh, 1vh) * 100);
        }
        @media (min-width: 640px) {
            #game-container {
                height: 90vh;
                max-height: 800px;
            }
        }
        .road-line {
            position: absolute; width: 6px; height: 100%; top: 0;
            background-image: linear-gradient(to bottom, white 50%, transparent 50%);
            background-size: 100% 70px; animation: road-lines 2.5s linear infinite;
        }
        @keyframes road-lines { from { background-position: 0 0; } to { background-position: 0 70px; } }
        @keyframes fall { from { transform: translateY(-100px); } to { transform: translateY(100vh); } }
        .falling { animation: fall 10s linear; }
        #car { transition: left 0.2s ease-out; }
        .modal { transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out; }
        .modal.hidden { opacity: 0; transform: scale(0.9); pointer-events: none; }
        #player-name-input { border: 2px solid #6366f1; transition: border-color 0.3s; }
        #player-name-input:focus { outline: none; border-color: #a5b4fc; }
        #leaderboard ol { list-style-type: decimal; padding-left: 2rem; }
        #leaderboard li { display: flex; justify-content: space-between; }
        .quiz-select-btn {
            transition: all 0.2s ease-in-out;
        }
        .quiz-select-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body class="bg-gray-800 flex items-center justify-center min-h-screen overflow-hidden">

    <div id="game-container" class="w-full max-w-md bg-gray-600 rounded-lg shadow-2xl flex flex-col relative overflow-hidden border-4 border-gray-700">
        
        <div class="bg-gray-900 text-white p-4 shadow-lg z-20 flex flex-col space-y-2">
            <div class="flex justify-between items-center text-base md:text-lg font-bold">
                <div id="player-info" class="hidden">Player: <span id="player-name-display"></span></div>
                <div id="score-display" class="hidden">점수: <span id="score">0</span></div>
            </div>
            <div id="question" class="text-center text-lg md:text-xl min-h-[5rem] flex items-center justify-center px-2 border-t border-gray-700 pt-2"></div>
        </div>

        <div id="game-screen" class="flex-1 relative">
            <div class="road-line" style="left: 33.33%; transform: translateX(-50%);"></div>
            <div class="road-line" style="left: 66.66%; transform: translateX(-50%);"></div>
            <div id="car" class="w-12 h-16 absolute bottom-8 left-1/2 -translate-x-1/2 text-5xl z-10">🚓</div>
            <div id="answers-container" class="absolute w-full h-24 flex justify-around" style="top: 0;"></div>
        </div>

        <div class="bg-gray-900 p-2 flex justify-center space-x-2 sm:hidden z-20">
            <button id="move-left-btn" class="w-1/3 bg-blue-500 text-white font-bold py-4 px-4 rounded-lg text-2xl active:bg-blue-700">◀</button>
            <button id="move-forward-btn" class="w-1/3 bg-green-500 text-white font-bold py-4 px-4 rounded-lg text-2xl active:bg-green-700">▲</button>
            <button id="move-right-btn" class="w-1/3 bg-blue-500 text-white font-bold py-4 px-4 rounded-lg text-2xl active:bg-blue-700">▶</button>
        </div>

        <div id="start-screen" class="modal absolute inset-0 bg-black bg-opacity-70 flex flex-col items-center justify-center z-30 px-4 overflow-y-auto py-4">
            <h1 id="start-title" class="text-3xl md:text-4xl font-bold text-white mb-4 text-center">외대부고 국어 기말대비 퀴즈</h1>
            
            <div id="name-input-container" class="w-full max-w-sm mb-4 flex-shrink-0">
                <label for="player-name-input" class="block text-white text-center mb-2">플레이어 이름을 입력하세요</label>
                <input type="text" id="player-name-input" class="w-full px-4 py-2 rounded-lg bg-gray-200 text-gray-800 text-center font-bold" placeholder="이름" maxlength="10">
            </div>

            <div id="quiz-selection-container" class="w-full max-w-sm flex-shrink-0">
                 <p id="start-desc" class="text-yellow-300 text-lg mb-4 text-center">플레이할 작품을 선택하세요!</p>
                 <div id="quiz-options" class="grid grid-cols-2 gap-3">
                 </div>
            </div>
            
            <div id="leaderboard" class="mt-6 w-full max-w-sm text-white bg-gray-800 bg-opacity-50 p-4 rounded-lg hidden flex-shrink-0">
                <h3 class="text-2xl text-yellow-300 font-bold text-center mb-2">🏆 명예의 전당 🏆</h3>
                <ol id="leaderboard-list" class="text-lg"></ol>
            </div>

            <div id="restart-container" class="mt-6 hidden flex-shrink-0">
                <button id="restart-button" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-8 rounded-full text-2xl shadow-lg transform hover:scale-105 transition-transform">
                    작품 선택으로
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";

        const elements = {
            car: document.getElementById('car'),
            gameScreen: document.getElementById('game-screen'),
            question: document.getElementById('question'),
            score: document.getElementById('score'),
            answersContainer: document.getElementById('answers-container'),
            startScreen: document.getElementById('start-screen'),
            startTitle: document.getElementById('start-title'),
            startDesc: document.getElementById('start-desc'),
            moveLeftBtn: document.getElementById('move-left-btn'),
            moveRightBtn: document.getElementById('move-right-btn'),
            moveForwardBtn: document.getElementById('move-forward-btn'),
            playerNameInput: document.getElementById('player-name-input'),
            playerNameDisplay: document.getElementById('player-name-display'),
            playerInfo: document.getElementById('player-info'),
            scoreDisplay: document.getElementById('score-display'),
            nameInputContainer: document.getElementById('name-input-container'),
            quizSelectionContainer: document.getElementById('quiz-selection-container'),
            quizOptions: document.getElementById('quiz-options'),
            leaderboard: document.getElementById('leaderboard'),
            leaderboardList: document.getElementById('leaderboard-list'),
            restartContainer: document.getElementById('restart-container'),
            restartButton: document.getElementById('restart-button')
        };
        
        let db;
        try {
            const firebaseConfig = {
                apiKey: "AIzaSyDcagfE320vd1DuT6uZ8mHhVy2yB74C1q0",
                authDomain: "grammar-294b6.firebaseapp.com",
                projectId: "grammar-294b6",
                storageBucket: "grammar-294b6.appspot.com",
                messagingSenderId: "865611264169",
                appId: "1:865611264169:web:84b9e6d784c3b41bd139b8"
            };
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            const auth = getAuth(app);
            signInAnonymously(auth).catch(error => console.error("Anonymous sign-in failed:", error));
        } catch (e) { console.error("Firebase initialization failed:", e); }

        let audioCtx;
        const setupAudio = () => { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); };
        const playSound = (type) => {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            if (type === 'correct') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(600, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(800, audioCtx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
            } else {
                osc.type = 'square'; osc.frequency.setValueAtTime(200, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.2);
                gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
            }
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + 0.2);
        };

        const quizzes = {
            '대화의 원리': [
                { question: "대화의 목적이나 방향에 맞게 서로 협력해야 한다는 원리는?", answers: ["공손성의 원리", "협력의 원리", "체면 유지의 원리"], correct: 1 },
                { question: "대화의 목적에 필요한 만큼만 정보를 제공해야 한다는 격률은?", answers: ["질의 격률", "양의 격률", "태도의 격률"], correct: 1 },
                { question: "진실되고 타당한 근거를 들어 말해야 한다는 격률은?", answers: ["관련성의 격률", "양의 격률", "질의 격률"], correct: 2 },
                { question: "대화의 주제와 관련 없는 말을 하는 것은 어떤 격률을 어긴 것인가?", answers: ["관련성의 격률", "질의 격률", "태도의 격률"], correct: 0 },
                { question: "모호하거나 중의적인 표현을 피하고 명료하게 말해야 한다는 격률은?", answers: ["양의 격률", "태도의 격률", "질의 격률"], correct: 1 },
                { question: "상대방에게 부담을 최소화하고 이익은 최대화해야 한다는 격률은?", answers: ["관용의 격률", "요령의 격률", "찬동의 격률"], correct: 1 },
                { question: "자신에게 오는 이익은 최소화하고 부담은 최대화해야 한다는 격률은?", answers: ["관용의 격률", "겸양의 격률", "요령의 격률"], correct: 0 },
                { question: "상대방을 비방하지 않고 칭찬을 많이 해야 한다는 격률은?", answers: ["요령의 격률", "찬동의 격률", "동의의 격률"], correct: 1 },
                { question: "자신에 대한 칭찬을 줄이고 겸손한 표현을 사용하는 격률은?", answers: ["겸양의 격률", "찬동의 격률", "관용의 격률"], correct: 0 },
                { question: "상대방과의 의견 차이는 최소화하고 일치점을 부각하는 격률은?", answers: ["찬동의 격률", "요령의 격률", "동의의 격률"], correct: 2 },
                { question: "다른 사람에게 인정받고 관계를 맺고 싶은 욕구와 관련된 체면은?", answers: ["소극적 체면", "적극적 체면", "중립적 체면"], correct: 1 },
                { question: "간섭받지 않고 자유롭게 행동하고 싶은 욕구와 관련된 체면은?", answers: ["적극적 체면", "소극적 체면", "공격적 체면"], correct: 1 },
                { question: "'창문 좀 열어줄래?'라고 말하는 것은 상대의 어떤 체면을 지켜주기 위함인가?", answers: ["적극적 체면", "사회적 체면", "소극적 체면"], correct: 2 },
                { question: "상대방을 칭찬하는 것은 상대의 어떤 체면을 세워주는 행위인가?", answers: ["소극적 체면", "적극적 체면", "방어적 체면"], correct: 1 },
                { question: "거짓말을 하지 말라는 것은 어떤 격률에 해당하는가?", answers: ["양의 격률", "태도의 격률", "질의 격률"], correct: 2 },
                { question: "'제가 잠시 신세를 좀 져도 괜찮을까요?'라는 말은 어떤 격률을 지킨 표현인가?", answers: ["찬동의 격률", "겸양의 격률", "요령의 격률"], correct: 2 },
                { question: "'제가 한 건 별로 없고 다 팀원들 덕분입니다.'라는 말은 어떤 격률을 지킨 표현인가?", answers: ["관용의 격률", "찬동의 격률", "요령의 격률"], correct: 0 },
                { question: "'네 생각도 일리가 있지만, 이 부분은 조금 다른 것 같아.'는 어떤 격률을 지킨 표현인가?", answers: ["동의의 격률", "찬동의 격률", "겸양의 격률"], correct: 0 },
                { question: "체면 유지의 원리는 어떤 원리와 밀접한 관련이 있는가?", answers: ["협력의 원리", "순서 교대의 원리", "공손성의 원리"], correct: 2 },
                { question: "대화의 원리를 지키는 주된 목적은 원활한 의사소통과 무엇인가?", answers: ["정보 획득", "자기표현", "관계 형성"], correct: 2 }
            ],
            '정의론': [
                { question: "존 롤스가 『정의론』에서 제시한 정의관의 핵심 명칭은?", answers: ["최대 행복 원리", "공정으로서의 정의", "절대적 평등"], correct: 1 },
                { question: "정의의 원칙에 합의하기 위해 롤스가 설정한 가상적 상황은?", answers: ["자연 상태", "원초적 입장", "이상 국가"], correct: 1 },
                { question: "원초적 입장의 구성원들이 자신의 정보를 모르는 상태를 가리는 장막은?", answers: ["무지의 베일", "망각의 강", "진실의 거울"], correct: 0 },
                { question: "롤스가 비판한, '최대 다수의 최대 행복'을 추구하는 이론은?", answers: ["자유지상주의", "공리주의", "공동체주의"], correct: 1 },
                { question: "정의의 제1원칙의 핵심 내용은?", answers: ["차등의 원칙", "기회 균등의 원칙", "평등한 자유의 원칙"], correct: 2 },
                { question: "정의의 제2원칙이 다루는 불평등은?", answers: ["정치적 불평등", "사회적·경제적 불평등", "문화적 불평등"], correct: 1 },
                { question: "사회·경제적 불평등이 정당화될 수 있는 조건과 관련 없는 것은?", answers: ["최소 수혜자에게 최대 이익", "공정한 기회 균등", "개인의 능력에 따른 분배"], correct: 2 },
                { question: "사회에서 가장 불리한 처지에 있는 사람들을 일컫는 롤즈의 용어는?", answers: ["사회적 약자", "최소 수혜자", "절대 빈곤층"], correct: 1 },
                { question: "정의의 두 원칙 사이의 우선순위로 옳은 것은?", answers: ["제2원칙이 제1원칙보다 우선", "두 원칙은 동등함", "제1원칙이 제2원칙보다 우선"], correct: 2 },
                { question: "롤즈의 정의론은 결과보다 무엇의 공정성을 중시하는가?", answers: ["의도", "절차", "분배"], correct: 1 },
                { question: "타고난 재능이나 사회적 여건 같은 요소의 특징은?", answers: ["필연성", "선택성", "우연성"], correct: 2 },
                { question: "원초적 입장은 사회 계약론의 어떤 상태에 해당하는가?", answers: ["자연 상태", "전쟁 상태", "문명 상태"], correct: 0 },
                { question: "롤즈의 정의론이 출간될 당시 지배적이었던 정치 철학 이념은?", answers: ["공리주의", "자유주의", "사회주의"], correct: 0 },
                { question: "제2원칙 내에서 우선하는 원칙은?", answers: ["차등의 원칙", "공정한 기회 균등의 원칙", "두 원칙은 동등"], correct: 1 },
                { question: "롤즈가 정의론을 통해 부활시켰다고 평가받는 철학 분야는?", answers: ["존재론", "인식론", "규범 철학"], correct: 2 },
                { question: "정의의 원칙을 실현하는 사회는 구성원들의 책무가 스스로 ()한 것이 되는 체계에 가깝다.", answers: ["강제", "부과", "계약"], correct: 1 },
                { question: "원초적 입장에서 합의된 기본적 합의가 공정한 이유는 그 최초의 상황이 ()하기 때문이다.", answers: ["자연스럽기", "공정하기", "평화롭기"], correct: 1 },
                { question: "롤즈의 정의론은 자본주의의 지배 이념이 되어 온 ()주의를 비판했다.", answers: ["자유지상주의", "복지", "공리"], correct: 2 },
                { question: "정의의 제1원칙은 사회적 공리나 일반적 ()보다 앞선다.", answers: ["선(善)", "정의", "행복"], correct: 2 },
                { question: "롤즈는 자신의 이론을 로크, 루소, 그리고 누구의 사회 계약론을 추상화한 것이라고 밝혔는가?", answers: ["홉스", "마키아벨리", "칸트"], correct: 2 }
            ],
            '올바른 발음과 표기': [
                { question: "음운 변동의 네 가지 유형이 아닌 것은?", answers: ["교체", "탈락", "합성"], correct: 2 },
                { question: "'부엌[부억]'에 적용된 음운 변동은?", answers: ["비음화", "된소리되기", "음절의 끝소리 규칙"], correct: 2 },
                { question: "'국물[궁물]'에 적용된 음운 변동은?", answers: ["비음화", "유음화", "구개음화"], correct: 0 },
                { question: "'신라[실라]'에 적용된 음운 변동은?", answers: ["비음화", "유음화", "된소리되기"], correct: 1 },
                { question: "'같이[가치]'에 적용된 음운 변동은?", answers: ["유음화", "구개음화", "된소리되기"], correct: 1 },
                { question: "'좋고[조ː코]'에 적용된 음운 변동은?", answers: ["탈락", "첨가", "축약(거센소리되기)"], correct: 2 },
                { question: "'닭[닥]'에 적용된 음운 변동은?", answers: ["자음군 단순화", "ㄹ 탈락", "ㅎ 탈락"], correct: 0 },
                { question: "'솜이불[솜ː니불]'에 적용된 음운 변동은?", answers: ["탈락", "첨가", "교체"], correct: 1 },
                { question: "음운 변동 결과 음운의 개수가 하나 줄어드는 유형은?", answers: ["교체, 첨가", "탈락, 축약", "교체, 탈락"], correct: 1 },
                { question: "용언 어간 'ㄹ'이 'ㄴ, ㅂ, ㅅ' 앞에서 탈락하는 현상은?", answers: ["유음화", "'ㄹ' 탈락", "자음군 단순화"], correct: 1 },
                { question: "국어의 음절 끝에서 발음될 수 있는 자음은 총 몇 개인가?", answers: ["5개", "7개", "9개"], correct: 1 },
                { question: "'값도'의 올바른 발음은?", answers: ["[갑또]", "[갑쏘]", "[가또]"], correct: 0 },
                { question: "'읊는'의 올바른 발음은?", answers: ["[을는]", "[읍는]", "[음는]"], correct: 2 },
                { question: "'법학'의 올바른 발음은?", answers: ["[법칵]", "[버팍]", "[보팍]"], correct: 1 },
                { question: "'할 것을'의 표준 발음은?", answers: ["[할꺼슬]", "[할거슬]", "[할것을]"], correct: 0 },
                { question: "'색연필'의 올바른 발음은?", answers: ["[새견필]", "[생년필]", "[색연필]"], correct: 1 },
                { question: "'앞마당'의 발음 [암마당]에서 일어나는 음운 변동을 순서대로 쓰시오.", answers: ["비음화, 유음화", "음절 끝소리, 비음화", "된소리되기, 비음화"], correct: 1 },
                { question: "음운 변동 결과 음운 개수에 변화가 없는 유형은?", answers: ["탈락", "교체", "축약"], correct: 1 },
                { question: "'담그다'에 '-아'가 붙으면 어떻게 표기해야 하는가?", answers: ["담구아", "담궈", "담가"], correct: 2 },
                { question: "'꽃잎'의 발음 [꼰닙]에 적용된 음운 변동 두 가지는?", answers: ["끝소리 규칙, ㄴ 첨가", "유음화, 비음화", "구개음화, ㄴ 첨가"], correct: 0 }
            ],
            '다원화 사회와 국어': [
                { question: "인종, 국적, 문화적 배경이 다양해지는 사회를 무엇이라 하는가?", answers: ["정보화 사회", "세계화 사회", "다원화 사회"], correct: 2 },
                { question: "서로 다른 문화를 동등하게 존중하고 이해하려는 태도는?", answers: ["문화 사대주의", "자문화 중심주의", "문화 상대주의"], correct: 2 },
                { question: "북한의 표준어는 평양말을 중심으로 하는 무엇인가?", answers: ["서울말", "문화어", "조선어"], correct: 1 },
                { question: "북한에서는 '역사'를 [력사]로 표기하는데, 어떤 법칙을 적용하지 않기 때문인가?", answers: ["구개음화", "모음조화", "두음 법칙"], correct: 2 },
                { question: "북한에서 '다이어트'를 의미하는 고유어 표현은?", answers: ["살빼기", "몸까기", "체중조절"], correct: 1 },
                { question: "남북이 공동으로 편찬 중인 통일 지향 사전의 이름은?", answers: ["우리말큰사전", "한민족어사전", "겨레말큰사전"], correct: 2 },
                { question: "《겨레말큰사전》에서 남북의 다른 표기를 모두 인정하는 것을 무엇이라 하는가?", answers: ["단일 표준", "복수 표준", "임시 표준"], correct: 1 },
                { question: "남북 분단으로 인해 발생한 언어의 차이를 언어의 무엇이라고 하는가?", answers: ["동질화", "이질화", "표준화"], correct: 1 },
                { question: "북한에서는 '클릭'을 무엇이라고 표현하는가?", answers: ["누르기", "찍기", "찰칵"], correct: 2 },
                { question: "다문화 사회에서 언어는 상호 인정과 무엇의 수단이 되어야 하는가?", answers: ["경쟁", "존중", "동화"], correct: 1 },
                { question: "북한에서는 '나뭇잎'을 '나무잎'으로 표기하는데, 무엇을 사용하지 않기 때문인가?", answers: ["사이시옷", "두음법칙", "띄어쓰기"], correct: 0 },
                { question: "남한에서 주로 거절의 의미로 쓰이는 '한번 생각해 보겠습니다'와 같은 화법은?", answers: ["직접 화행", "간접 화행", "명령 화행"], correct: 1 },
                { question: "남북한 언어의 차이에도 불구하고 의사소통이 가능한 기반을 무엇이라 하는가?", answers: ["언어의 역사성", "언어의 동질성", "언어의 창조성"], correct: 1 },
                { question: "남북한 언어 동질성 회복이 필요한 이유는?", answers: ["경제 발전", "문화 교류", "사회 통합"], correct: 2 },
                { question: "'의외로 ○○ 출신'과 같은 표현의 문제점은?", answers: ["문법 오류", "의미의 모호성", "차별과 편견 내포"], correct: 2 },
                { question: "이주 배경 주민과 소통할 때 바람직한 태도가 아닌 것은?", answers: ["쉬운 어휘 사용", "끝까지 경청하기", "관용 표현 자주 사용"], correct: 2 },
                { question: "북한어 '랭면'은 남한의 무엇에 해당하는가?", answers: ["라면", "냉면", "국수"], correct: 1 },
                { question: "통일을 대비하기 위해 남북한 언어의 무엇을 회복하는 노력이 필요한가?", answers: ["창조성", "역사성", "동질성"], correct: 2 },
                { question: "북한에서는 한자어나 외래어 대신 어떤 말 중심으로 언어를 순화하려 하는가?", answers: ["방언", "신조어", "고유어"], correct: 2 },
                { question: "언어생활에서 책임감을 갖는다는 것은 자신의 말이 타인에게 미칠 무엇을 고려하는 것인가?", answers: ["재미", "영향", "이익"], correct: 1 }
            ],
            '견해 글쓰기': [
                { question: "견해를 표현하는 글쓰기의 궁극적인 목적은?", answers: ["정보 전달", "독자 설득", "정서 표현"], correct: 1 },
                { question: "수집한 자료의 출처가 분명하고 믿을 만한지 판단하는 기준은?", answers: ["타당성", "공정성", "신뢰성"], correct: 2 },
                { question: "주장하는 글의 일반적인 3단 구성은?", answers: ["기-승-전-결", "발단-전개-위기-절정-결말", "서론-본론-결론"], correct: 2 },
                { question: "글의 전체적인 뼈대를 짜는 일을 무엇이라 하는가?", answers: ["주제 설정", "개요 작성", "초고 쓰기"], correct: 1 },
                { question: "글쓰기의 모든 과정에서 수시로 이루어질 수 있는 단계는?", answers: ["계획하기", "표현하기", "고쳐쓰기"], correct: 2 },
                { question: "글의 3단 구성 중, 문제 상황을 제시하고 독자의 흥미를 유발하는 부분은?", answers: ["서론", "본론", "결론"], correct: 0 },
                { question: "글의 3단 구성 중, 타당한 근거를 들어 주장을 증명하는 가장 중요한 부분은?", answers: ["서론", "본론", "결론"], correct: 1 },
                { question: "사회적 쟁점을 다루는 글에 효과적인 내용 조직 방식은?", answers: ["시간 순서 구조", "문제 해결 구조", "공간 이동 구조"], correct: 1 },
                { question: "글쓰기를 계획할 때 고려해야 할 '쓰기 맥락' 요소가 아닌 것은?", answers: ["주제", "예상 독자", "글쓴이의 필체"], correct: 2 },
                { question: "글쓰기 전, 글의 방향을 정하기 위해 가장 먼저 분석해야 할 것은?", answers: ["쓰기 맥락", "맞춤법", "표현 기법"], correct: 0 },
                { question: "수집한 자료가 주장을 뒷받침할 만큼 합리적인지 판단하는 기준은?", answers: ["공정성", "최신성", "타당성"], correct: 2 },
                { question: "수집한 자료가 한쪽에 치우치지 않았는지 판단하는 기준은?", answers: ["타당성", "신뢰성", "공정성"], correct: 2 },
                { question: "본론에서 주장을 펼칠 때, 주장을 뒷받침하는 무엇을 함께 제시해야 하는가?", answers: ["감상", "일화", "근거"], correct: 2 },
                { question: "개요를 바탕으로 처음 써 내려간 글을 무엇이라 하는가?", answers: ["완성본", "초고", "퇴고"], correct: 1 },
                { question: "학교 누리집이라는 매체의 특성을 고려할 때, 효과적인 자료는?", answers: ["구술 자료", "시각 자료", "인쇄 자료"], correct: 1 },
                { question: "전문가의 의견이나 통계 자료를 근거로 제시하면 글의 무엇을 높일 수 있는가?", answers: ["신뢰성", "창의성", "오락성"], correct: 0 },
                { question: "예상 독자인 학생들이 실천하기 어려운 방안을 개요에서 삭제한 것은 무엇을 고려한 것인가?", answers: ["주제", "목적", "예상 독자"], correct: 2 },
                { question: "견해를 표현하는 글쓰기는 사회적 쟁점을 어떻게 하여 민주적 문제 해결에 기여하는가?", answers: ["은폐하여", "공론화하여", "단순화하여"], correct: 1 },
                { question: "내용 생성 단계에서는 어떤 매체에서 자료를 수집하는 것이 바람직한가?", answers: ["한 종류의 매체", "다양한 매체", "가장 오래된 매체"], correct: 1 },
                { question: "글쓰기의 사회적 기능으로 가장 적절한 것은?", answers: ["개인의 정서 표현", "공동체 문제 해결에 기여", "오락적 즐거움 제공"], correct: 1 }
            ],
            '논증과 토론': [
                { question: "자신의 주장이 옳다는 것을 이유와 근거를 들어 증명하는 과정은?", answers: ["논쟁", "토의", "논증"], correct: 2 },
                { question: "논증의 3가지 기본 요소는 주장, 이유, 그리고 무엇인가?", answers: ["사례", "근거", "결론"], correct: 1 },
                { question: "주장을 뒷받침하는 객관적인 사실 자료를 무엇이라 하는가?", answers: ["의견", "근거", "전제"], correct: 1 },
                { question: "일반적 원리에서 구체적 사실을 이끌어내는 논증 방법은?", answers: ["귀납", "유추", "연역"], correct: 2 },
                { question: "여러 구체적인 사례를 바탕으로 일반적인 결론을 이끌어내는 논증 방법은?", answers: ["연역", "귀납", "변증"], correct: 1 },
                { question: "정책의 실행 여부를 다루는 토론에서 반드시 다루어야 할 필수 쟁점이 아닌 것은?", answers: ["문제의 심각성", "해결 방안의 효과", "사회자의 중립성"], correct: 2 },
                { question: "정책 토론에서 '현재 상황에 심각한 문제가 있다'는 것을 증명해야 하는 책임은 어느 측에 있는가?", answers: ["사회자", "반대 측", "찬성 측"], correct: 2 },
                { question: "상대방 입론의 문제점을 질문을 통해 검증하는 단계를 무엇이라 하는가?", answers: ["반론", "확인 신문", "반대 신문"], correct: 2 },
                { question: "토론에서 상대 주장을 무너뜨릴 수 있는 구체적인 반대 사례를 무엇이라 하는가?", answers: ["예외", "반례", "오류"], correct: 1 },
                { question: "본문 토론의 논제인 '로봇세'는 로봇을 소유한 사람이나 기업에 무엇을 부과하는 제도인가?", answers: ["벌금", "세금", "의무"], correct: 1 },
                { question: "찬성 측은 로봇세의 재원으로 누구를 도울 수 있다고 주장했는가?", answers: ["기업가", "과학자", "실업자"], correct: 2 },
                { question: "반대 측은 로봇세 도입이 우리나라의 어떤 산업을 위축시킬 수 있다고 우려했는가?", answers: ["농업", "서비스업", "로봇 산업"], correct: 2 },
                { question: "토론을 듣는 청중이 가져야 할 가장 바람직한 태도는?", answers: ["자신의 입장과 같은 편만 응원", "중립적이고 객관적인 태도", "토론 내용에 개입하는 것"], correct: 1 },
                { question: "어떤 정책 실행의 이익과 비용을 비교하는 것은 필수 쟁점 중 어디에 해당하는가?", answers: ["문제", "해결 방안", "효과와 이익"], correct: 2 },
                { question: "반대 신문을 할 때, 상대방의 논리적 무엇을 지적하는 것이 효과적인가?", answers: ["감정", "태도", "허점"], correct: 2 },
                { question: "'로봇 밀도'가 세계에서 가장 높다는 근거는 필수 쟁점 중 무엇의 심각성을 뒷받침하는가?", answers: ["해결 방안", "효과와 이익", "문제"], correct: 2 },
                { question: "토론은 상반된 입장을 교환하여 문제를 어떻게 해결하는 데 목적이 있는가?", answers: ["신속하게", "합리적으로", "다수결로"], correct: 1 },
                { question: "근거 자료는 공신력 있는 기관의 어떤 자료를 활용하는 것이 좋은가?", answers: ["홍보 자료", "개인 의견", "통계 자료"], correct: 2 },
                { question: "자신의 주장에 대해 제기될 수 있는 반대 의견을 무엇이라 하는가?", answers: ["예상 반론", "최종 주장", "핵심 근거"], correct: 0 },
                { question: "반대 측은 찬성 측의 주장에 대한 어떤 책임을 지는가?", answers: ["입증 책임", "반증 책임", "사회적 책임"], correct: 1 }
            ]
        };
        
        let carPosition, score, currentQuestionIndex, gameLoopId, playerName, currentQuizData;
        let isGameActive = false;
        let questionInProgress = false;

        const initGame = () => {
            carPosition = 1; score = 0; currentQuestionIndex = 0;
            isGameActive = true; questionInProgress = false;
            elements.playerInfo.classList.remove('hidden');
            elements.scoreDisplay.classList.remove('hidden');
            elements.playerNameDisplay.textContent = playerName;
            document.querySelectorAll('.road-line').forEach(line => line.style.animationPlayState = 'running');
            updateScore();
            shuffleQuiz();
            loadQuestion();
            updateCarPosition();
            elements.quizSelectionContainer.classList.add('hidden');
            elements.startScreen.classList.add('hidden');
            if (gameLoopId) cancelAnimationFrame(gameLoopId);
            gameLoopId = requestAnimationFrame(gameLoop);
        };

        const gameLoop = () => {
            if (!isGameActive) return;
            const carRect = elements.car.getBoundingClientRect();
            const answersRect = elements.answersContainer.getBoundingClientRect();
            if (questionInProgress && answersRect.bottom > carRect.top && answersRect.top < carRect.bottom) {
                handleCollision();
            }
            if (questionInProgress && answersRect.top > window.innerHeight) {
                handleCollision(true);
            }
            gameLoopId = requestAnimationFrame(gameLoop);
        };
        
        const handleCollision = (missed = false) => {
            if (!questionInProgress) return;
            questionInProgress = false;
            elements.answersContainer.style.animationPlayState = 'paused';
            const currentQuiz = currentQuizData[currentQuestionIndex];
            const correctGate = elements.answersContainer.children[currentQuiz.correct];
            if (missed) {
                if (correctGate) correctGate.classList.replace('bg-blue-500', 'bg-yellow-500');
                playSound('incorrect');
            } else {
                if (carPosition === currentQuiz.correct) {
                    score += 5; updateScore();
                    correctGate.classList.replace('bg-blue-500', 'bg-green-500');
                    playSound('correct');
                } else {
                    const wrongGate = elements.answersContainer.children[carPosition];
                    if (wrongGate) wrongGate.classList.replace('bg-blue-500', 'bg-red-600');
                    if (correctGate) correctGate.classList.replace('bg-blue-500', 'bg-green-500');
                    playSound('incorrect');
                }
            }
            currentQuestionIndex++;
            setTimeout(loadQuestion, 1000);
        };

        const checkAnswerNow = () => { if (questionInProgress) handleCollision(false); };

        const shuffleQuiz = () => {
            for (let i = currentQuizData.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [currentQuizData[i], currentQuizData[j]] = [currentQuizData[j], currentQuizData[i]];
            }
        };

        const loadQuestion = () => {
            if (currentQuestionIndex >= currentQuizData.length) {
                endGame();
                return;
            }
            questionInProgress = true;
            const currentQuiz = currentQuizData[currentQuestionIndex];
            elements.question.textContent = `Q${currentQuestionIndex + 1}. ${currentQuiz.question}`;
            elements.answersContainer.innerHTML = '';
            currentQuiz.answers.forEach((answer) => {
                const answerEl = document.createElement('div');
                answerEl.className = 'w-1/3 h-full flex items-center justify-center text-white text-base md:text-lg font-bold p-2 text-center bg-blue-500 bg-opacity-75 border-2 border-blue-300 rounded-lg';
                answerEl.textContent = answer;
                elements.answersContainer.appendChild(answerEl);
            });
            elements.answersContainer.classList.remove('falling');
            void elements.answersContainer.offsetWidth;
            elements.answersContainer.style.animationPlayState = 'running';
            elements.answersContainer.classList.add('falling');
        };

        const endGame = async () => {
            isGameActive = false;
            cancelAnimationFrame(gameLoopId);
            document.querySelectorAll('.road-line').forEach(line => line.style.animationPlayState = 'paused');
            await saveScore(playerName, score);
            await displayLeaderboard();
            elements.question.textContent = `퀴즈 완료! 최종 점수: ${score}점`;
            elements.answersContainer.innerHTML = '';
            elements.playerInfo.classList.add('hidden');
            elements.scoreDisplay.classList.add('hidden');
            elements.startTitle.textContent = "게임 클리어!";
            elements.startDesc.innerHTML = `최종 점수: <span class="text-2xl text-white font-bold">${score}</span>점`;
            elements.nameInputContainer.classList.add('hidden');
            elements.quizSelectionContainer.classList.add('hidden');
            elements.leaderboard.classList.remove('hidden');
            elements.restartContainer.classList.remove('hidden'); 
            elements.startScreen.classList.remove('hidden');
        };

        const updateCarPosition = () => {
            const laneWidth = elements.gameScreen.offsetWidth / 3;
            elements.car.style.left = `${(carPosition * laneWidth) + (laneWidth / 2)}px`;
        };

        const moveCar = (direction) => {
            if (!isGameActive) return;
            if (direction === 'left' && carPosition > 0) carPosition--;
            else if (direction === 'right' && carPosition < 2) carPosition++;
            updateCarPosition();
        };

        const updateScore = () => { elements.score.textContent = score; };

        const saveScore = async (name, score) => {
            if (!db) return;
            try { await addDoc(collection(db, "hafs-korean-scores"), { name, score, createdAt: serverTimestamp() }); } 
            catch (e) { console.error("Error adding document: ", e); }
        };

        const displayLeaderboard = async () => {
            if (!db) return;
            elements.leaderboardList.innerHTML = '<li>불러오는 중...</li>';
            try {
                const q = query(collection(db, "hafs-korean-scores"), orderBy("score", "desc"), limit(5));
                const querySnapshot = await getDocs(q);
                elements.leaderboardList.innerHTML = '';
                if (querySnapshot.empty) {
                    elements.leaderboardList.innerHTML = '<li>아직 랭킹이 없습니다.</li>';
                    return;
                }
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const li = document.createElement('li');
                    li.innerHTML = `<span>${data.name}</span><span>${data.score}점</span>`;
                    elements.leaderboardList.appendChild(li);
                });
            } catch (e) {
                console.error("Error getting documents: ", e);
                elements.leaderboardList.innerHTML = '<li>랭킹을 불러오지 못했습니다.</li>';
            }
        };

        const populateQuizOptions = () => {
            elements.quizOptions.innerHTML = ''; 
            const quizNames = {
                '대화의 원리': quizzes['대화의 원리'],
                '정의론': quizzes['정의론'],
                '운영전': quizzes['운영전'],
                '올바른 발음과 표기': quizzes['올바른 발음과 표기'],
                '다원화 사회와 국어': quizzes['다원화 사회와 국어'],
                '견해 글쓰기와 논증': quizzes['견해 글쓰기와 논증'],
                '고전 수필': quizzes['고전 수필'],
                '고전 시가': quizzes['고전 시가']
            };
            
            Object.keys(quizNames).forEach(quizName => {
                const btn = document.createElement('button');
                btn.textContent = quizName.replace('과 논증', '').replace('와 국어',''); // 버튼 텍스트 간결화
                btn.className = "quiz-select-btn w-full bg-indigo-500 text-white font-bold py-3 px-2 rounded-lg text-sm md:text-lg active:bg-indigo-700";
                btn.onclick = () => {
                    setupAudio();
                    playerName = elements.playerNameInput.value.trim();
                    if (!playerName) {
                        elements.playerNameInput.placeholder = "이름을 꼭 입력해주세요!";
                        elements.playerNameInput.classList.add('border-red-500');
                        setTimeout(() => {
                            elements.playerNameInput.classList.remove('border-red-500');
                            elements.playerNameInput.placeholder = "이름";
                        }, 1500);
                        return;
                    }
                    currentQuizData = quizNames[quizName];
                    initGame();
                };
                elements.quizOptions.appendChild(btn);
            });
        };

        const resetToSelection = () => {
            elements.startTitle.textContent = "외대부고 국어 기말대비 퀴즈";
            elements.startDesc.textContent = "플레이할 작품을 선택하세요!";
            elements.restartContainer.classList.add('hidden');
            elements.leaderboard.classList.add('hidden');
            elements.nameInputContainer.classList.remove('hidden');
            elements.quizSelectionContainer.classList.remove('hidden');
        };
        
        populateQuizOptions();

        document.addEventListener('keydown', (e) => {
            if (elements.startScreen.classList.contains('hidden')) {
                if (e.key === 'ArrowLeft') moveCar('left');
                else if (e.key === 'ArrowRight') moveCar('right');
                else if (e.key === 'ArrowUp' || e.key === ' ') { e.preventDefault(); checkAnswerNow(); }
            }
        });

        elements.moveLeftBtn.addEventListener('click', () => moveCar('left'));
        elements.moveRightBtn.addEventListener('click', () => moveCar('right'));
        elements.moveForwardBtn.addEventListener('click', checkAnswerNow);
        elements.restartButton.addEventListener('click', resetToSelection);
        window.addEventListener('resize', () => { if (isGameActive) updateCarPosition(); });
    </script>
</body>
</html>
